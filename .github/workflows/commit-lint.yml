name: Validate Commit Messages

on:
  push:
    branches:
      - development
  pull_request:
    branches:
      - development

jobs:
  check-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate commit messages
        run: |
          invalid=0
          for commit in $(git rev-list ${{ github.event.before }}..${{ github.event.after }}); do
            message=$(git log --format=%B -n 1 $commit)
            first_line=$(echo "$message" | head -n 1)
            last_line=$(echo "$message" | tail -n 1)

            # Check the format of the first line
            if ! echo "$first_line" | grep -qE "^\[Taurus-[0-9]+\]:"; then
              echo "::error ::Commit $commit has an invalid first line: $first_line"
              invalid=1
            fi

            # Check the format of the last line
            if ! echo "$last_line" | grep -qE "^Signed-off-by: .+ <.+@tataelxsi\.co\.in>$"; then
              echo "::error ::Commit $commit has an invalid Signed-off-by line: $last_line"
              invalid=1
            fi
          done

          if [ "$invalid" -eq 1 ]; then
            echo "❌ Commit message validation failed."
            exit 1
          else
            echo "✅ All commit messages are valid."
          fi
